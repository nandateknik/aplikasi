<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nanda Teknik - Buat Booking</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        :root { --p-blue: #0052d4; --p-grad: linear-gradient(135deg, #0052d4 0%, #4364f7 50%, #6fb1fc 100%); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f4f7fe; padding-bottom: 100px; }
        .header-section { background: var(--p-grad); padding: 30px 20px 50px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; color: white; margin-bottom: -30px; }
        .card-main { background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none; position: relative; z-index: 10; }
        #map { height: 220px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .price-box { background: #f8fafc; border-radius: 18px; padding: 15px; border: 1px dashed #cbd5e1; }
        .form-control, .form-select { border-radius: 12px; border: none; background: #f1f5f9; padding: 10px 15px; font-size: 0.9rem; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; height: 75px; display: flex; align-items: center; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-link { flex: 1; text-align: center; color: #94a3b8; text-decoration: none; font-size: 0.7rem; font-weight: 600; }
        .nav-link.active { color: var(--p-blue); }
        .nav-link i { font-size: 1.5rem; display: block; margin-bottom: 3px; }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="loader-overlay" id="loader">
    <div class="spinner-border text-primary"></div>
    <span class="mt-2 fw-bold">Menyimpan...</span>
</div>

<div class="header-section text-center shadow">
    <h5 class="fw-bold mb-0">Input Booking Manual</h5>
    <p class="small opacity-75">Nanda Teknik Management</p>
</div>

<div class="container mt-4">
    <div class="card-main mb-3">
        <label class="form-label small fw-bold text-muted">DATA PELANGGAN</label>
        <div class="input-group mb-2 shadow-sm rounded-3 overflow-hidden">
            <span class="input-group-text bg-white border-0"><i class="fas fa-search text-muted"></i></span>
            <input type="text" id="emailInput" class="form-control bg-white" list="emailList" placeholder="Cari Email/Nama..." oninput="BookingModule.checkSelection()">
            <datalist id="emailList"></datalist>
        </div>

        <div id="customerBadge" class="alert alert-primary py-2 px-3 mb-3 d-none shadow-sm" style="border-radius: 15px; border: none;">
            <div class="d-flex align-items-center">
                <i class="fas fa-user-circle fs-3 me-2 text-primary"></i>
                <div>
                    <div class="fw-bold small" id="selectedName">Nama Pelanggan</div>
                    <div style="font-size: 0.65rem;" id="selectedWA">08123...</div>
                </div>
            </div>
        </div>

        <label class="form-label small fw-bold text-muted mt-2">JADWAL PENGERJAAN</label>
        <input type="datetime-local" id="tglBooking" class="form-control mb-3 shadow-sm">

        <div class="d-flex justify-content-between align-items-center mb-2 mt-2">
            <label class="form-label small fw-bold text-muted mb-0">LOKASI PENGERJAAN</label>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="useOldAddr" onchange="MapModule.toggleMapSync()">
                <label class="form-check-label small" for="useOldAddr">Data Pelanggan</label>
            </div>
        </div>

        <div id="mapContainer"><div id="map"></div></div>
        <textarea id="alamat" class="form-control mb-3 shadow-sm" rows="2" placeholder="Detail Alamat..."></textarea>
        <input type="hidden" id="lat"><input type="hidden" id="lng">

        <hr class="opacity-10">

        <label class="form-label small fw-bold text-muted">TAMBAH JASA / SPAREPART</label>
        <div class="row g-2 mb-2">
            <div class="col-8">
                <select id="jasaSelect" class="form-select shadow-sm"></select>
            </div>
            <div class="col-4">
                <button class="btn btn-primary w-100 fw-bold shadow-sm" onclick="BookingModule.addItem()" style="border-radius: 12px;">Add</button>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-5">
                <input type="text" id="manualNama" class="form-control shadow-sm" placeholder="Nama Manual">
            </div>
            <div class="col-4">
                <input type="number" id="manualHarga" class="form-control shadow-sm" placeholder="Harga">
            </div>
            <div class="col-3">
                <button class="btn btn-outline-primary w-100 fw-bold shadow-sm" onclick="BookingModule.addManualItem()" style="border-radius: 12px; font-size: 0.8rem;">Manual</button>
            </div>
        </div>

        <div id="itemContainer"></div>

        <div class="price-box mt-3 shadow-sm">
            <div class="d-flex justify-content-between small text-muted mb-1">
                <span>Bensin (Jarak <span id="txtJarak">0</span>km)</span>
                <span id="txtBensin">Rp 0</span>
            </div>
            <div class="d-flex justify-content-between fw-bold text-primary fs-5">
                <span>TOTAL AKHIR</span>
                <span id="txtTotal">Rp 0</span>
            </div>
        </div>

        <button class="btn btn-primary w-100 mt-4 py-3 fw-bold shadow" onclick="BookingModule.submitBooking()" style="border-radius: 20px; background: var(--p-blue);">
            SIMPAN WORK ORDER & NOTA
        </button>
    </div>
</div>

<div class="bottom-nav">
    <a href="admin.html" class="nav-link"><i class="fas fa-list-ul"></i>Riwayat</a>
    <a href="#" class="nav-link active"><i class="fas fa-plus-circle" style="font-size: 2.5rem; color: var(--p-blue); position: relative; top: -10px;"></i></a>
    <a href="pelanggan.html" class="nav-link"><i class="fas fa-users"></i>Pelanggan</a>
</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script src="map-module.js"></script>
<script src="booking-module.js"></script>

<script>
    // Inisialisasi pas load
    window.onload = async () => {
        BookingModule.initTime();
        MapModule.init();
        await BookingModule.loadInitialData();
    };
</script>

</body>
</html>
