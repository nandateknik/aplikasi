<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gudang (Restock) - POS PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="lg:ml-64 flex flex-col min-h-screen">
        <div id="layout-header"></div>

        <main class="p-4 lg:p-8 flex-1">
            <div class="mb-8">
                <h2 class="text-3xl font-black text-slate-800 tracking-tight">MANAJEMEN STOK</h2>
                <p class="text-sm text-slate-500 font-medium">Tambah stok barang masuk dari supplier ke sistem.</p>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                
                <section class="xl:col-span-4 space-y-6">
                    <div class="bg-white rounded-[32px] p-8 shadow-sm border border-slate-100 sticky top-24">
                        <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center text-2xl mb-6">üì¶</div>
                        <h3 class="font-black text-slate-800 uppercase tracking-widest text-xs mb-6">Input Stok Masuk</h3>
                        
                        <div class="space-y-4">
                            <input type="hidden" id="g-id">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Produk Terpilih</label>
                                <input type="text" id="g-nama" readonly class="!bg-slate-50 !border-slate-100 cursor-not-allowed font-bold text-slate-700 !py-3" placeholder="Klik 'Pilih' di tabel...">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Stok Saat Ini</label>
                                    <input type="text" id="g-stok-lama" readonly class="!bg-slate-50 !border-slate-100 cursor-not-allowed text-center font-black text-slate-500 !py-3">
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-orange-600 uppercase tracking-widest ml-1">Jumlah Tambah</label>
                                    <input type="number" id="g-tambah" placeholder="0" class="text-center !border-orange-200 focus:ring-orange-500 text-xl font-black !py-3 !rounded-2xl">
                                </div>
                            </div>
                            
                            <div class="pt-4 space-y-3">
                                <button onclick="updateStok()" class="w-full bg-orange-600 text-white py-4 rounded-2xl font-black hover:bg-orange-700 shadow-xl shadow-orange-100 transition-all active:scale-95">
                                    KONFIRMASI STOK
                                </button>
                                <button onclick="resetForm()" class="w-full text-slate-400 text-[10px] font-black hover:text-slate-600 uppercase tracking-widest transition-colors">Batalkan Pilihan</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="xl:col-span-8 space-y-8">
                    
                    <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 p-6 md:p-8">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                            <div>
                                <h3 class="font-black text-slate-800 uppercase tracking-widest text-xs">Cek & Pilih Barang</h3>
                            </div>
                            <div class="relative w-full md:w-72">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 opacity-30">üîç</span>
                                <input type="text" id="g-search" onkeyup="renderGudang()" placeholder="Cari nama barang..." class="!pl-10 !rounded-2xl !py-2.5 text-sm font-bold border-slate-200">
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-slate-400 text-[10px] uppercase tracking-widest border-b border-slate-50">
                                        <th class="pb-4 font-black">Produk</th>
                                        <th class="pb-4 text-center font-black">Stok Akhir</th>
                                        <th class="pb-4 text-center font-black">Status</th>
                                        <th class="pb-4 text-right font-black">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="gudang-table-body" class="text-sm">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-[32px] shadow-sm border border-slate-100 p-6 md:p-8">
                        <h3 class="font-black text-slate-800 uppercase tracking-widest text-xs mb-6 flex items-center gap-2">
                            <span class="text-lg">üïí</span> Riwayat Restock Terbaru
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-slate-400 text-[10px] uppercase tracking-widest border-b border-slate-50">
                                        <th class="pb-4 font-black">Waktu</th>
                                        <th class="pb-4 font-black">Produk</th>
                                        <th class="pb-4 text-center font-black">Qty</th>
                                        <th class="pb-4 text-right font-black">Petugas</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="text-xs font-bold text-slate-600">
                                    </tbody>
                            </table>
                            <div id="no-history" class="hidden py-12 text-center text-slate-300 italic text-xs uppercase tracking-widest font-black">Belum ada riwayat masuk</div>
                        </div>
                    </div>

                </section>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/layout.js"></script>
    <script>
        // 1. RENDER TABEL PRODUK
        async function renderGudang() {
            const searchQuery = document.getElementById('g-search').value.toLowerCase();
            const products = await db.products.toArray();
            const filtered = products.filter(p => p.nama.toLowerCase().includes(searchQuery));
            
            const body = document.getElementById('gudang-table-body');
            body.innerHTML = filtered.reverse().map(p => `
                <tr class="border-b border-slate-50 hover:bg-orange-50/20 transition-all group">
                    <td class="py-5">
                        <div class="font-black text-slate-700 uppercase text-xs tracking-tight">${p.nama}</div>
                        <div class="text-[10px] text-slate-400 font-bold">KODE: PRD-${p.id}</div>
                    </td>
                    <td class="py-5 text-center">
                        <span class="text-lg font-black ${p.stock < 5 ? 'text-red-500 animate-pulse' : 'text-slate-800'}">${p.stock}</span>
                    </td>
                    <td class="py-5 text-center">
                        ${p.stock < 5 ? 
                            '<span class="bg-red-50 text-red-500 text-[9px] px-2 py-1 rounded-lg font-black uppercase">Kritis</span>' : 
                            '<span class="bg-green-50 text-green-600 text-[9px] px-2 py-1 rounded-lg font-black uppercase">Aman</span>'}
                    </td>
                    <td class="py-5 text-right">
                        <button onclick="pilihProduk(${p.id}, '${p.nama}', ${p.stock})" 
                                class="bg-orange-50 text-orange-600 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-orange-600 hover:text-white transition-all">
                            PILIH
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 2. PILIH PRODUK
        function pilihProduk(id, nama, stok) {
            document.getElementById('g-id').value = id;
            document.getElementById('g-nama').value = nama;
            document.getElementById('g-stok-lama').value = stok;
            document.getElementById('g-tambah').value = '';
            document.getElementById('g-tambah').focus();
            
            if(window.innerWidth < 1024) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 3. UPDATE STOK & RIWAYAT
        async function updateStok() {
            const id = document.getElementById('g-id').value;
            const nama = document.getElementById('g-nama').value;
            const tambah = parseInt(document.getElementById('g-tambah').value);
            const stokLama = parseInt(document.getElementById('g-stok-lama').value);

            if(!id) return alert("Pilih produknya dulu, Bro!");
            if(isNaN(tambah) || tambah <= 0) return alert("Isi jumlah tambahan yang valid ya!");

            try {
                const totalBaru = stokLama + tambah;
                await db.products.update(Number(id), { stock: totalBaru });

                await db.stock_history.add({
                    waktu: new Date().getTime(),
                    produkId: Number(id),
                    namaProduk: nama,
                    jumlah: tambah,
                    petugas: session.nama || 'Admin'
                });
                
                resetForm();
                renderGudang();
                renderHistory();
            } catch (e) {
                alert("Gagal: " + e.message);
            }
        }

        // 4. RENDER RIWAYAT
        async function renderHistory() {
            const history = await db.stock_history.toArray();
            const body = document.getElementById('history-table-body');
            const noHistoryMsg = document.getElementById('no-history');

            if(history.length === 0) {
                noHistoryMsg.classList.remove('hidden');
                body.innerHTML = '';
                return;
            } else {
                noHistoryMsg.classList.add('hidden');
            }
            
            body.innerHTML = history.sort((a,b) => b.waktu - a.waktu).slice(0, 10).map(h => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                    <td class="py-4">
                        <div class="text-slate-800">${new Date(h.waktu).toLocaleDateString('id-ID')}</div>
                        <div class="text-[9px] text-slate-400 font-bold">${new Date(h.waktu).toLocaleTimeString('id-ID')}</div>
                    </td>
                    <td class="py-4 text-slate-800 uppercase tracking-tighter">${h.namaProduk}</td>
                    <td class="py-4 text-center">
                        <span class="bg-green-50 text-green-600 px-2 py-1 rounded-lg text-[10px]">+${h.jumlah}</span>
                    </td>
                    <td class="py-4 text-right">
                        <span class="text-slate-400 text-[10px] uppercase">${h.petugas}</span>
                    </td>
                </tr>
            `).join('');
        }

        function resetForm() {
            document.getElementById('g-id').value = '';
            document.getElementById('g-nama').value = '';
            document.getElementById('g-stok-lama').value = '';
            document.getElementById('g-tambah').value = '';
        }

        renderGudang();
        renderHistory();
    </script>
</body>
</html>
