<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Penawaran | Nanda Teknik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="layout.css">
    <style>
        body { background: #f4f7fe; padding-bottom: 100px; }
        .admin-card { background: white; border-radius: 20px; border: none; margin-top: 20px; position: relative; z-index: 99; }
        .btn-action { width: 35px; height: 35px; display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; margin: 2px; border: none; }
        .badge-status { padding: 5px 12px; border-radius: 8px; font-weight: 600; font-size: 0.7rem; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-sent { background: #d1ecf1; color: #0c5460; }
        .status-approved { background: #d4edda; color: #155724; }
        /* Style Search Suggester */
        #search-results { position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <div class="card admin-card p-4 shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold m-0 text-primary">Manajemen Penawaran</h5>
                        <small class="text-muted">Nanda Teknik Pro - V4.9</small>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary btn-sm rounded-pill me-2" onclick="loadPenawaran()">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="btn btn-primary btn-sm rounded-pill" onclick="showAddModal()">
                            <i class="fas fa-plus me-1"></i> Baru
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Email Pelanggan</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="modalTitle">Buat Penawaran</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formPenawaran">
                    <input type="hidden" id="edit-id">
                    
                    <div class="mb-3 position-relative">
                        <label class="form-label small fw-bold">Cari Pelanggan (Nama/Email)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search"></i></span>
                            <input type="text" id="search-pelanggan" class="form-control bg-light border-start-0" placeholder="Ketik nama pelanggan..." oninput="searchPelanggan(this.value)">
                        </div>
                        <div id="search-results" class="list-group shadow-sm"></div>
                        <input type="hidden" id="form-email" required>
                        <div id="selected-email-display" class="mt-2 small text-primary fw-bold"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Item Penawaran</label>
                        <div id="items-container"></div>
                        <button type="button" class="btn btn-light btn-sm mt-2 w-100" onclick="addItemRow()">
                            <i class="fas fa-plus-circle me-1"></i> Tambah Baris
                        </button>
                    </div>

                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Status</label>
                            <select id="form-status" class="form-select rounded-3">
                                <option value="Pending">Pending</option>
                                <option value="Sent">Sent</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                        <div class="col-md-6 text-end">
                            <label class="form-label small fw-bold">Total Estimasi</label>
                            <h3 class="text-primary fw-bold" id="display-total">Rp 0</h3>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-4 rounded-3 py-2 fw-bold" id="btnSimpan">SIMPAN DATA</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="config.js"></script>

<script>
    let allData = [];
    let listPelanggan = [];
    const modalForm = new bootstrap.Modal(document.getElementById('modalForm'));

    window.onload = () => {
        loadPenawaran();
        fetchPelanggan(); // Load data pelanggan buat fitur search
    };

    async function fetchPelanggan() {
        try {
            const res = await fetch(CONFIG.WEB_APP_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'getAllPelanggan' }) 
            });
            const r = await res.json();
            if(r.success) listPelanggan = r.data;
        } catch(e) { console.error("Gagal load pelanggan"); }
    }

    function searchPelanggan(query) {
        const resultsBox = document.getElementById('search-results');
        if (query.length < 2) { resultsBox.style.display = 'none'; return; }
        
        const filtered = listPelanggan.filter(p => 
            p[0].toLowerCase().includes(query.toLowerCase()) || 
            p[1].toLowerCase().includes(query.toLowerCase())
        );

        if (filtered.length > 0) {
            resultsBox.innerHTML = filtered.map(p => `
                <button type="button" class="list-group-item list-group-item-action" onclick="selectPelanggan('${p[0]}', '${p[1]}')">
                    <div class="fw-bold">${p[0]}</div>
                    <small class="text-muted">${p[1]}</small>
                </button>
            `).join('');
            resultsBox.style.display = 'block';
        } else {
            resultsBox.style.display = 'none';
        }
    }

    function selectPelanggan(nama, email) {
        document.getElementById('form-email').value = email;
        document.getElementById('search-pelanggan').value = nama;
        document.getElementById('selected-email-display').innerText = "Email Terpilih: " + email;
        document.getElementById('search-results').style.display = 'none';
    }

    async function loadPenawaran() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>';
        
        try {
            const res = await fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Penawaran`);
            const result = await res.json();
            if (result.success) {
                allData = result.data;
                tbody.innerHTML = allData.map(row => `
                    <tr>
                        <td class="fw-bold">#${row.id}</td>
                        <td>${row.email}</td>
                        <td class="fw-bold text-success">Rp ${Number(row.total).toLocaleString('id-ID')}</td>
                        <td><span class="badge-status status-${row.status.toLowerCase()}">${row.status}</span></td>
                        <td class="text-center">
                            <button class="btn btn-light btn-action" onclick="editPenawaran('${row.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-primary btn-action" onclick='generatePDF(${JSON.stringify(row)})'><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-danger btn-action" onclick="deletePenawaran('${row.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">Gagal load data.</td></tr>'; }
    }

    function showAddModal() {
        document.getElementById('formPenawaran').reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('selected-email-display').innerText = '';
        document.getElementById('items-container').innerHTML = '';
        addItemRow();
        modalForm.show();
    }

    function addItemRow(nama = '', harga = 0, qty = 1) {
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 item-row';
        div.innerHTML = `
            <div class="col-6"><input type="text" placeholder="Nama Barang" class="form-control it-nama" value="${nama}" required></div>
            <div class="col-3"><input type="number" placeholder="Harga" class="form-control it-harga" value="${harga}" oninput="calcTotal()" required></div>
            <div class="col-2"><input type="number" placeholder="Qty" class="form-control it-qty" value="${qty}" oninput="calcTotal()" required></div>
            <div class="col-1"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove();calcTotal()"><i class="fas fa-times"></i></button></div>
        `;
        document.getElementById('items-container').appendChild(div);
    }

    function calcTotal() {
        let total = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const h = row.querySelector('.it-harga').value || 0;
            const q = row.querySelector('.it-qty').value || 0;
            total += (h * q);
        });
        document.getElementById('display-total').innerText = 'Rp ' + total.toLocaleString('id-ID');
        return total;
    }

    document.getElementById('formPenawaran').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSimpan');
        btn.disabled = true;
        
        const id = document.getElementById('edit-id').value;
        const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
            nama: row.querySelector('.it-nama').value,
            harga: parseInt(row.querySelector('.it-harga').value),
            qty: parseInt(row.querySelector('.it-qty').value)
        }));

        const payload = {
            action: id ? 'updatePenawaran' : 'createPenawaran',
            id: id,
            email: document.getElementById('form-email').value,
            items: items,
            total: calcTotal(),
            status: document.getElementById('form-status').value
        };

        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
        
        try {
            const res = await fetch(CONFIG.WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if (result.success) {
                Swal.fire('Berhasil!', 'Penawaran wis disimpan.', 'success');
                modalForm.hide();
                loadPenawaran();
            }
        } catch(e) { Swal.fire('Error', 'Gagal kirim data', 'error'); }
        btn.disabled = false;
    };

    function editPenawaran(id) {
        const data = allData.find(r => r.id === id);
        if (!data) return;
        document.getElementById('edit-id').value = data.id;
        document.getElementById('form-email').value = data.email;
        document.getElementById('search-pelanggan').value = data.email;
        document.getElementById('form-status').value = data.status;
        document.getElementById('items-container').innerHTML = '';
        data.items_json.forEach(it => addItemRow(it.nama, it.harga, it.qty));
        calcTotal();
        modalForm.show();
    }

    async function deletePenawaran(id) {
        const confirm = await Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true });
        if (confirm.isConfirmed) {
            await fetch(CONFIG.WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'deletePenawaran', id: id }) });
            loadPenawaran();
        }
    }

    function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const items = data.items_json;

        doc.setFontSize(20).setTextColor(0, 82, 212).text("NANDA TEKNIK", 105, 20, {align:"center"});
        doc.setFontSize(10).setTextColor(100).text("Banyuwangi - Telp/WA: 082331201148", 105, 26, {align:"center"});
        doc.line(14, 30, 196, 30);

        doc.setTextColor(0).setFontSize(14).text(`PENAWARAN HARGA #${data.id}`, 14, 45);
        doc.setFontSize(10).text(`Tujuan: ${data.email}`, 14, 52);
        doc.text(`Tanggal: ${new Date(data.tanggal).toLocaleDateString('id-ID')}`, 14, 58);

        const tableBody = items.map((it, i) => [i + 1, it.nama, it.qty, `Rp ${it.harga.toLocaleString()}`, `Rp ${(it.qty * it.harga).toLocaleString()}`]);

        doc.autoTable({
            startY: 65,
            head: [['No', 'Deskripsi', 'Qty', 'Harga', 'Subtotal']],
            body: tableBody,
            headStyles: { fillColor: [0, 82, 212] },
            foot: [['', '', '', 'TOTAL', `Rp ${Number(data.total).toLocaleString()}`]],
            footStyles: { fillColor: [240, 240, 240], textColor: [0], fontStyle: 'bold' }
        });

        doc.text("Hormat Kami,", 150, doc.lastAutoTable.finalY + 20);
        doc.text("Nanda Teknik Admin", 150, doc.lastAutoTable.finalY + 40);
        doc.save(`Penawaran_${data.id}.pdf`);
    }
</script>
</body>
</html>
