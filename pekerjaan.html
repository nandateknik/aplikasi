<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order & Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f0f2f5; font-family: 'Inter', sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        #map { height: 200px; border-radius: 12px; margin-bottom: 15px; }
        
        /* Timeline style ala Tokopedia */
        .timeline { position: relative; padding-left: 30px; list-style: none; }
        .timeline::before { content: ""; position: absolute; left: 10px; top: 5px; bottom: 5px; width: 2px; background: #e0e0e0; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-item::after { content: ""; position: absolute; left: -25px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #00AA5B; border: 2px solid #fff; }
        .timeline-date { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
        .timeline-status { font-weight: bold; font-size: 0.9rem; color: #333; }
        .timeline-detail { font-size: 0.85rem; color: #666; }
    </style>
</head>
<body>

<div class="container py-4">
    <ul class="nav nav-pills nav-justified mb-4 bg-white p-2 rounded-pill shadow-sm">
        <li class="nav-item">
            <a class="nav-link active rounded-pill" data-bs-toggle="pill" href="#tabInput">Buat WO</a>
        </li>
        <li class="nav-item">
            <a class="nav-link rounded-pill" data-bs-toggle="pill" href="#tabTrack">Cek Status</a>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tabInput">
            <div class="card p-4">
                <h5 class="fw-bold mb-3"><i class="fas fa-tools me-2 text-primary"></i>Form Pekerjaan</h5>
                <div class="mb-3">
                    <label class="form-label">Email Pelanggan</label>
                    <input type="email" id="wo_email" class="form-control" placeholder="Email terdaftar">
                </div>
                <div class="mb-3">
                    <label class="form-label">Jenis Pekerjaan</label>
                    <select id="wo_jenis" class="form-select">
                        <option value="Perbaikan">Perbaikan</option>
                        <option value="Instalasi">Instalasi Baru</option>
                        <option value="Maintenance">Maintenance Rutin</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Lokasi Pengerjaan</label>
                    <div id="map"></div>
                    <input type="hidden" id="wo_lat">
                    <input type="hidden" id="wo_lang">
                </div>
                <button class="btn btn-primary w-100 p-3 fw-bold" onclick="simpanWO()">BUAT BOOKING SEKARANG</button>
            </div>
        </div>

        <div class="tab-pane fade" id="tabTrack">
            <div class="card p-4">
                <h5 class="fw-bold mb-3">Lacak Pesanan</h5>
                <div class="input-group mb-4">
                    <input type="text" id="trackId" class="form-control" placeholder="Masukkan Kode WO (Contoh: WO-XYZ...)">
                    <button class="btn btn-dark" onclick="lacakWO()">Cari</button>
                </div>

                <div id="resultTrack" style="display:none;">
                    <div class="alert alert-success border-0 mb-4">
                        <small class="d-block">Status Saat Ini:</small>
                        <strong id="currentStatus">-</strong>
                    </div>
                    <h6 class="fw-bold mb-3">Histori Perjalanan</h6>
                    <ul class="timeline" id="timelineList">
                        </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwYQCSDIhfArz5ahy46CJI4uKskSaNqs-gvGPAqp6nUGcpj1MxAS1Jaqb2I_Jt7Tgg9/exec';
    let map, marker;

    // Inisialisasi Map sederhana
    function initMap() {
        map = L.map('map').setView([-6.2000, 106.8166], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.marker([-6.2000, 106.8166], {draggable: true}).addTo(map);
        
        marker.on('dragend', function() {
            let pos = marker.getLatLng();
            document.getElementById('wo_lat').value = pos.lat;
            document.getElementById('wo_lang').value = pos.lng;
        });
    }

    async function simpanWO() {
        const data = {
            action: 'createBooking',
            email: document.getElementById('wo_email').value,
            pekerjaan: document.getElementById('wo_jenis').value,
            lat: document.getElementById('wo_lat').value,
            lang: document.getElementById('wo_lang').value
        };

        if(!data.email) return Swal.fire('Error', 'Email wajib diisi', 'error');

        Swal.fire({title: 'Sedang memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await res.json();
        
        if(result.success) {
            Swal.fire('Berhasil!', `Kode Booking: ${result.bookingId}`, 'success');
        }
    }

    async function lacakWO() {
        const id = document.getElementById('trackId').value;
        if(!id) return;

        const res = await fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'getBookingStatus', bookingId: id }) 
        });
        const result = await res.json();

        if(result.success) {
            document.getElementById('resultTrack').style.display = 'block';
            document.getElementById('currentStatus').innerText = result.data.status;
            
            let html = '';
            result.data.progress.reverse().forEach(item => { // Reverse agar yang terbaru di atas
                let date = new Date(item.datetime).toLocaleString('id-ID');
                html += `
                    <li class="timeline-item">
                        <div class="timeline-date">${date}</div>
                        <div class="timeline-status">${item.status}</div>
                        <div class="timeline-detail">${item.detail}</div>
                    </li>
                `;
            });
            document.getElementById('timelineList').innerHTML = html;
        } else {
            Swal.fire('Maaf', 'Kode Booking tidak ditemukan', 'error');
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
