<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; font-family: 'Inter', sans-serif; }
        .card { border-radius: 20px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        #map { height: 250px; border-radius: 15px; margin: 10px 0; border: 2px solid #fff; }
        .is-valid-email { color: #198754; font-size: 0.8rem; display: none; }
        .btn-register { display: none; margin-top: 5px; }
        .price-box { background: #e9ecef; padding: 15px; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card p-4">
                <h5 class="fw-bold mb-4 text-center">Buat Work Order</h5>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Email Pelanggan</label>
                    <div class="input-group">
                        <input type="email" id="email" class="form-control" placeholder="Cari email..." oninput="checkEmailDelay()">
                        <span class="input-group-text bg-white" id="statusIcon"><i class="fas fa-search text-muted"></i></span>
                    </div>
                    <div id="emailMsg" class="is-valid-email mt-1"><i class="fas fa-check-circle"></i> Pelanggan Terdaftar</div>
                    <button id="btnReg" class="btn btn-sm btn-danger btn-register w-100" onclick="location.href='pelanggan.html'">Email tidak ada. Daftar Sekarang?</button>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="syncAddress" onchange="toggleSync()">
                    <label class="form-check-label small" for="syncAddress">Alamat sama dengan data pendaftaran</label>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Titik Lokasi Pekerjaan</label>
                    <div id="map"></div>
                    <textarea id="alamat" class="form-control" rows="2" placeholder="Detail alamat pekerjaan..."></textarea>
                    <input type="hidden" id="lat">
                    <input type="hidden" id="lang">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Jenis Jasa</label>
                    <select id="jasaSelect" class="form-select" onchange="hitungTotal()">
                        <option value="manual">-- Input Manual --</option>
                    </select>
                    <input type="number" id="jasaManual" class="form-control mt-2" placeholder="Input harga jasa (Rp)" oninput="hitungTotal()">
                </div>

                <div class="price-box">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Jarak dari Kantor (5km free):</span>
                        <span id="txtJarak">0 km</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Ongkos Bensin:</span>
                        <span id="txtBensin">Rp 0</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold border-top pt-2">
                        <span>TOTAL BIAYA:</span>
                        <span id="txtTotal">Rp 0</span>
                    </div>
                </div>

                <button class="btn btn-primary w-100 mt-4 p-3 fw-bold" onclick="simpanBooking()">SIMPAN WORK ORDER</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzu_BavPA7Y87dDJRyLBYv-rdFF5u-Ws93hBK3bW7_yv8Rai1FDTiG7pMFjY2dyhULz/exec';
    const KANTOR_COORDS = { lat: -6.2000, lng: 106.8166 }; // Ganti koordinat kantor anda
    let map, marker, pelangganData = null, timeoutCheck;

    window.onload = () => {
        initMap();
        loadDaftarHarga();
    };

    function initMap() {
        map = L.map('map').setView([KANTOR_COORDS.lat, KANTOR_COORDS.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        L.Control.geocoder({ defaultMarkGeocode: false }).on('markgeocode', function(e) {
            let center = e.geocode.center;
            map.setView(center, 16);
            marker.setLatLng(center);
            updateLocationInfo(center.lat, center.lng);
        }).addTo(map);

        marker = L.marker([KANTOR_COORDS.lat, KANTOR_COORDS.lng], {draggable: true}).addTo(map);
        marker.on('dragend', (e) => updateLocationInfo(e.target.getLatLng().lat, e.target.getLatLng().lng));

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                marker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                updateLocationInfo(pos.coords.latitude, pos.coords.longitude);
            });
        }
    }

    function updateLocationInfo(lat, lng) {
        document.getElementById('lat').value = lat;
        document.getElementById('lang').value = lng;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json()).then(data => {
                document.getElementById('alamat').value = data.display_name;
                hitungTotal();
            });
    }

    // Cek Email Realtime (Debounce)
    function checkEmailDelay() {
        clearTimeout(timeoutCheck);
        timeoutCheck = setTimeout(checkEmail, 800);
    }

    async function checkEmail() {
        const email = document.getElementById('email').value;
        if(email.length < 5) return;

        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getPelangganByEmail', email: email }) });
        const result = await res.json();

        if(result.success) {
            pelangganData = result.data;
            document.getElementById('statusIcon').innerHTML = '<i class="fas fa-check text-success"></i>';
            document.getElementById('emailMsg').style.display = 'block';
            document.getElementById('btnReg').style.display = 'none';
        } else {
            pelangganData = null;
            document.getElementById('statusIcon').innerHTML = '<i class="fas fa-times text-danger"></i>';
            document.getElementById('emailMsg').style.display = 'none';
            document.getElementById('btnReg').style.display = 'block';
        }
    }

    function toggleSync() {
        if(document.getElementById('syncAddress').checked && pelangganData) {
            const lat = pelangganData.lat;
            const lng = pelangganData.lang;
            map.setView([lat, lng], 16);
            marker.setLatLng([lat, lng]);
            document.getElementById('alamat').value = pelangganData.alamat;
            document.getElementById('lat').value = lat;
            document.getElementById('lang').value = lng;
            hitungTotal();
        }
    }

    async function loadDaftarHarga() {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getDaftarHarga' }) });
        const result = await res.json();
        const select = document.getElementById('jasaSelect');
        result.data.forEach(item => {
            select.innerHTML += `<option value="${item[1]}">${item[0]} (Rp ${item[1].toLocaleString()})</option>`;
        });
    }

    function hitungTotal() {
        const lat = document.getElementById('lat').value;
        const lng = document.getElementById('lang').value;
        if(!lat) return;

        // Hitung Jarak (Haversine Formula)
        const jarak = map.distance([lat, lng], [KANTOR_COORDS.lat, KANTOR_COORDS.lng]) / 1000;
        document.getElementById('txtJarak').innerText = jarak.toFixed(2) + " km";

        // Hitung Bensin: (Jarak - 5km) * 10000
        let ongkosBensin = 0;
        if(jarak > 5) {
            ongkosBensin = Math.ceil(jarak - 5) * 10000;
        }
        document.getElementById('txtBensin').innerText = "Rp " + ongkosBensin.toLocaleString();

        // Harga Jasa
        let hargaJasa = 0;
        const select = document.getElementById('jasaSelect');
        if(select.value === 'manual') {
            document.getElementById('jasaManual').style.display = 'block';
            hargaJasa = parseInt(document.getElementById('jasaManual').value) || 0;
        } else {
            document.getElementById('jasaManual').style.display = 'none';
            hargaJasa = parseInt(select.value);
        }

        const total = ongkosBensin + hargaJasa;
        document.getElementById('txtTotal').innerText = "Rp " + total.toLocaleString();
    }
</script>
</body>
</html>
