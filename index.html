<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanda Teknik - Portal Pelanggan</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --g-blue: #1a73e8; --g-gray: #5f6368; --bg-light: #f8f9fa; }
        body { background: white; font-family: 'Segoe UI', Roboto, sans-serif; color: #202124; padding-bottom: 100px; }
        
        /* Search Box */
        .search-wrapper { max-width: 650px; margin: 40px auto 20px; text-align: center; }
        .google-input-group {
            position: relative; background: #fff; border: 1px solid #dfe1e5;
            border-radius: 28px; padding: 12px 20px 12px 50px; transition: 0.3s;
        }
        .google-input-group:hover, .google-input-group:focus-within { box-shadow: 0 2px 8px rgba(32,33,36,0.15); border-color: transparent; }
        .google-input-group input { border: none; width: 100%; outline: none; font-size: 16px; }
        .search-icon-fixed { position: absolute; left: 18px; top: 14px; color: #9aa0a6; }

        /* Dashboard Antrean (NEW) */
        .queue-box { 
            background: #fff; border: 1px solid #dadce0; border-radius: 12px; 
            padding: 15px; margin-bottom: 30px; 
        }
        .queue-item {
            display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee;
        }
        .queue-item:last-child { border-bottom: none; }
        .dot-status { height: 10px; width: 10px; border-radius: 50%; margin-right: 10px; }
        .dot-proses { background: #fbbc04; box-shadow: 0 0 5px #fbbc04; }

        /* News Cards */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .news-card {
            display: flex; background: #fff; border: 1px solid #dadce0; 
            border-radius: 12px; overflow: hidden; text-decoration: none; color: inherit;
            transition: 0.3s; height: 100px;
        }
        .news-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .news-img { width: 100px; height: 100px; object-fit: cover; }
        .news-body { padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .news-body h6 { font-size: 0.9rem; font-weight: 600; margin: 0; color: #1a0dab; }

        /* Activity Card */
        .activity-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 12px;
            padding: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .activity-card:hover { border-color: var(--g-blue); background: #f8f9ff; }
        .icon-box { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .bg-work { background: #e8f0fe; color: #1a73e8; }
        .bg-note { background: #e6f4ea; color: #137333; }

        .pagination-container { display: flex; justify-content: center; gap: 8px; margin-top: 15px; }
        .page-btn { border: 1px solid #dadce0; background: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; }
        
        .section-header { font-size: 1rem; font-weight: 600; margin: 25px 0 12px; display: flex; align-items: center; gap: 8px; }
        .status-pill { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
        
        .fab-btn { position: fixed; bottom: 25px; right: 25px; background: var(--g-blue); color: white; padding: 12px 20px; border-radius: 25px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: 600; }
    </style>
</head>
<body>

<div class="container mt-3">
    <div class="search-wrapper">
        <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png" height="30" style="filter: hue-rotate(150deg); margin-bottom: 10px;">
        <div class="google-input-group">
            <i class="fas fa-search search-icon-fixed"></i>
            <input type="text" id="searchInput" placeholder="Cari Riwayat atau Nota Anda..." oninput="handleSearch()">
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div id="profileArea"></div>

            <div id="queueSection">
                <div class="section-header text-danger"><i class="fas fa-clock"></i> Daftar Antrean Teknisi (On-Progress)</div>
                <div class="queue-box shadow-sm" id="queueContent">
                    <p class="text-muted small p-3">Memuat data antrean...</p>
                </div>
            </div>

            <div id="newsArea">
                <div class="section-header"><i class="far fa-newspaper text-primary"></i> Berita & Tips</div>
                <div id="rssContent" class="news-grid"></div>
            </div>

            <div id="resultsArea" style="display:none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="section-header"><i class="fas fa-tools text-primary"></i> Riwayat Layanan</div>
                        <div id="workList"></div>
                        <div id="workPagination" class="pagination-container"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="section-header"><i class="fas fa-file-invoice-dollar text-success"></i> Nota & Invoice</div>
                        <div id="noteList"></div>
                        <div id="notePagination" class="pagination-container"></div>
                    </div>
                </div>
            </div>

            <div id="emptyState" style="display:none;" class="text-center py-5">
                <p class="text-muted small">Data tidak ditemukan.</p>
            </div>
        </div>
    </div>
</div>

<a href="buat-booking.html" class="fab-btn"><i class="fas fa-calendar-plus me-2"></i> Booking Servis</a>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="config.js"></script>

<script>
    let dbPelanggan = [], dbBooking = [], dbNota = [];
    let workPage = 1, notePage = 1;
    const itemsPerPage = 3;

    window.onload = async () => {
        loadRSS();
        await loadAllData();
        renderQueue(); // Jalankan antrean setelah data siap
    };

    async function loadAllData() {
        try {
            const [resP, resB, resN] = await Promise.all([
                fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Pelanggan`),
                fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Booking`),
                fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Penawaran`)
            ]);
            const [p, b, n] = await Promise.all([resP.json(), resB.json(), resN.json()]);
            dbPelanggan = p.data || [];
            dbBooking = b.data || [];
            dbNota = n.data || [];
        } catch(e) { console.error("Database Error"); }
    }

    // FUNGSI ANTREAN (NEW)
    function renderQueue() {
        const jobs = dbBooking.filter(j => j.status !== "Selesai" && j.status !== "Dibatalkan");
        const container = document.getElementById('queueContent');
        
        if (jobs.length === 0) {
            container.innerHTML = '<p class="text-muted small p-2 mb-0">Semua pekerjaan telah selesai dikerjakan.</p>';
            return;
        }

        container.innerHTML = jobs.map(j => `
            <div class="queue-item">
                <div class="dot-status dot-proses"></div>
                <div class="flex-grow-1">
                    <div class="fw-bold small">${j.id} - ${j.judul}</div>
                    <div class="text-muted" style="font-size: 11px;">Pelanggan: ${j.nama || 'User'} | Status: <b>${j.status}</b></div>
                </div>
                <div class="text-end text-muted" style="font-size: 10px;">${j.tanggal || j.tgl}</div>
            </div>
        `).join('');
    }

    function loadRSS() {
        const rssUrl = "https://www.nandateknik.com/feeds/posts/default?alt=rss";
        fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('rssContent').innerHTML = data.items.slice(0, 4).map(item => `
                    <a href="${item.link}" target="_blank" class="news-card">
                        <img src="${item.thumbnail || 'https://via.placeholder.com/150'}" class="news-img">
                        <div class="news-body">
                            <h6>${item.title}</h6>
                            <span class="text-muted" style="font-size: 10px;">${new Date(item.pubDate).toLocaleDateString('id-ID')}</span>
                        </div>
                    </a>
                `).join('');
            });
    }

    function handleSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        if (query.length < 3) { resetSearch(); return; }

        const user = dbPelanggan.find(u => u.email?.toLowerCase().includes(query) || u.nama?.toLowerCase().includes(query));
        const works = dbBooking.filter(w => w.email?.toLowerCase().includes(query) || w.id?.toLowerCase().includes(query));
        const notes = dbNota.filter(n => n.email?.toLowerCase().includes(query) || n.id?.toLowerCase().includes(query));

        if (!user && works.length === 0 && notes.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('resultsArea').style.display = 'none';
            document.getElementById('queueSection').style.display = 'none';
            return;
        }

        document.getElementById('newsArea').style.display = 'none';
        document.getElementById('queueSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('resultsArea').style.display = 'block';

        renderProfile(user);
        renderWorks(works);
        renderNotes(notes);
    }

    function resetSearch() {
        document.getElementById('newsArea').style.display = 'block';
        document.getElementById('queueSection').style.display = 'block';
        document.getElementById('resultsArea').style.display = 'none';
        document.getElementById('profileArea').innerHTML = '';
        document.getElementById('emptyState').style.display = 'none';
    }

    function renderProfile(u) {
        if (!u) return;
        document.getElementById('profileArea').innerHTML = `
            <div class="bg-light p-3 rounded-4 mb-3 border-start border-4 border-primary">
                <h5 class="fw-bold mb-0">${u.nama}</h5>
                <p class="text-muted small mb-0">${u.email} | ${u.wa}</p>
            </div>`;
    }

    function renderWorks(data) {
        const start = (workPage - 1) * itemsPerPage;
        document.getElementById('workList').innerHTML = data.slice(start, start+itemsPerPage).map(w => `
            <div class="activity-card" onclick="showWorkDetail('${w.id}')">
                <div class="d-flex align-items-center">
                    <div class="icon-box bg-work"><i class="fas fa-wrench"></i></div>
                    <div><div class="fw-bold small">${w.judul}</div><div class="text-muted" style="font-size:11px;">${w.tanggal || w.tgl}</div></div>
                </div>
                <span class="status-pill bg-blue">${w.status}</span>
            </div>
        `).join('') || '<p class="text-muted small">Kosong.</p>';
        renderPagination('workPagination', data.length, 'workPage', () => renderWorks(data));
    }

    function renderNotes(data) {
        const start = (notePage - 1) * itemsPerPage;
        document.getElementById('noteList').innerHTML = data.slice(start, start+itemsPerPage).map(n => `
            <div class="activity-card" onclick="showNoteDetail('${n.id}')">
                <div class="d-flex align-items-center">
                    <div class="icon-box bg-note"><i class="fas fa-file-invoice"></i></div>
                    <div><div class="fw-bold small">Nota #${n.id}</div><div class="text-success fw-bold" style="font-size:11px;">Rp ${Number(n.total).toLocaleString()}</div></div>
                </div>
                <span class="status-pill bg-green">${n.status}</span>
            </div>
        `).join('') || '<p class="text-muted small">Kosong.</p>';
        renderPagination('notePagination', data.length, 'notePage', () => renderNotes(data));
    }

    function renderPagination(target, total, pageVar, cb) {
        const totalPages = Math.ceil(total / itemsPerPage);
        if (totalPages <= 1) { document.getElementById(target).innerHTML = ''; return; }
        document.getElementById(target).innerHTML = `
            <button class="page-btn" ${window[pageVar] === 1 ? 'disabled' : ''} onclick="${pageVar}--; ${cb.name}()">Prev</button>
            <span style="font-size:11px;">${window[pageVar]}/${totalPages}</span>
            <button class="page-btn" ${window[pageVar] === totalPages ? 'disabled' : ''} onclick="${pageVar}++; ${cb.name}()">Next</button>
        `;
    }

    function showWorkDetail(id) {
        const w = dbBooking.find(x => x.id === id);
        Swal.fire({ title: 'Detail Servis', html: `<div class="text-start small"><b>ID:</b> ${id}<br><b>Status:</b> ${w.status}<br><hr>${w.deskripsi || '-'}</div>` });
    }

    function showNoteDetail(id) {
        const n = dbNota.find(x => x.id === id);
        const pId = `p-${id}`;
        Swal.fire({
            width: '600px',
            html: `<div id="${pId}" class="p-4 text-start bg-white"><h5 class="fw-bold text-primary">NANDA TEKNIK</h5><p class="small">Invoice #${id}</p><hr><div class="d-flex justify-content-between"><span>Total:</span><span class="fw-bold">Rp ${Number(n.total).toLocaleString()}</span></div></div><button class="btn btn-success mt-2 btn-sm" onclick="downloadPDF('${pId}','${id}')">Download PDF</button>`,
            showConfirmButton: false, showCloseButton: true
        });
    }

    function downloadPDF(el, id) {
        html2pdf().set({ margin:10, filename:`Invoice-${id}.pdf`, html2canvas:{scale:3} }).from(document.getElementById(el)).save();
    }
</script>
</body>
</html>
