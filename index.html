<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - Nanda Teknik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --p-blue: #0d6efd; --bg-soft: #f4f7fe; }
        body { background: var(--bg-soft); font-family: 'Segoe UI', sans-serif; padding-bottom: 100px; color: #334155; }
        .header-brand { background: white; padding: 25px 20px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); text-align: center; margin-bottom: 25px; }
        .header-brand h4 { font-weight: 800; color: var(--p-blue); margin-bottom: 2px; }
        .header-brand p { font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
        .search-container { background: white; border-radius: 20px; padding: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .search-container input { border: none; background: transparent; padding-left: 15px; font-weight: 600; }
        .search-container input:focus { box-shadow: none; }
        .card-custom { border-radius: 25px; border: none; box-shadow: 0 8px 25px rgba(0,0,0,0.04); display: none; background: white; margin-bottom: 20px; overflow: hidden; }
        .history-item { background: #fff; border: 1px solid #f1f5f9; border-radius: 18px; padding: 12px 15px; margin-bottom: 10px; transition: 0.2s; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .history-item:active { background: #f8fafc; transform: scale(0.98); }
        .history-item.active-item { border-color: var(--p-blue); background: #eff6ff; }
        .status-step { border-left: 2px solid #e2e8f0; padding-left: 20px; position: relative; padding-bottom: 15px; }
        .status-step::before { content: ""; position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--p-blue); border: 2px solid white; box-shadow: 0 0 0 2px var(--p-blue); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid #f1f5f9; }
        .nav-item { border: none; background: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: 700; width: 33%; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: var(--p-blue); }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="loader-overlay" id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="mt-3 fw-bold small">Sinkronisasi Data...</span>
</div>

<div class="header-brand animate__animated animate__fadeInDown">
    <h4>NANDA TEKNIK</h4>
    <p>Engineering & Technology</p>
</div>

<div class="container">
    <div class="search-container d-flex align-items-center mb-4">
        <i class="fas fa-search text-muted ms-3"></i>
        <input type="text" id="searchInput" class="form-control" placeholder="Email / ID WO / ID Nota">
        <button class="btn btn-primary rounded-pill px-4" onclick="cariData()">Cari</button>
    </div>

    <div id="cardHistory" class="card-custom p-4 animate__animated animate__fadeInUp">
        <h6 class="fw-bold mb-3 small"><i class="fas fa-history me-2 text-primary"></i>Riwayat Layanan</h6>
        <div id="historyList"></div>
    </div>

    <div id="cardWO" class="card-custom p-4 animate__animated animate__fadeInUp">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <span class="badge bg-primary bg-opacity-10 text-primary mb-2 rounded-pill small">WORK ORDER</span>
                <h4 id="woIdDisplay" class="fw-bold m-0">#WO-000</h4>
                <p id="woCustomer" class="small text-muted mb-0">--</p>
            </div>
            <span id="woStatus" class="badge bg-warning text-dark rounded-pill px-3 py-2 small">Pending</span>
        </div>
        <div id="woHistory" class="mt-4"></div>
    </div>

    <div id="cardNota" class="card-custom p-4 animate__animated animate__fadeInUp">
        <div class="text-center border-bottom pb-3 mb-3">
            <h6 class="fw-bold text-primary mb-1">DATA NOTA / INVOICE</h6>
            <span id="notaIdDisplay" class="text-muted small fw-bold">#INV-000</span>
        </div>
        <div class="table-responsive">
            <table class="table table-sm small">
                <thead><tr><th>Layanan</th><th class="text-end">Subtotal</th></tr></thead>
                <tbody id="notaItems"></tbody>
            </table>
        </div>
        <div class="bg-light p-3 rounded-4 d-flex justify-content-between align-items-center mb-4">
            <span class="small fw-bold">Total Bayar</span>
            <h5 class="fw-bold text-primary m-0" id="notaTotal">Rp 0</h5>
        </div>
        <button class="btn btn-success w-100 rounded-pill py-3 fw-bold shadow-sm" onclick="downloadNotaPDF()">
            <i class="fas fa-file-pdf me-2"></i> DOWNLOAD PDF RESMI
        </button>
    </div>

    <div id="noData" class="text-center py-5" style="display:none;">
        <i class="fas fa-search fa-3x text-muted mb-3 opacity-20"></i>
        <h6 class="text-muted fw-bold">Data ora ketemu, cah!</h6>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="location.reload()"><i class="fas fa-home"></i>Portal</button>
    <button class="nav-item" onclick="window.location.href='https://wa.me/6282331201148'"><i class="fab fa-whatsapp"></i>WA</button>
    <button class="nav-item" onclick="window.location.href='login.html'"><i class="fas fa-user-lock"></i>Admin</button>
</nav>

<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx-yvnYijId9ViAFQHnIM6BjQnwAr-onhLxrpaUSmlEZS5CIU5U-IozkCijI2buqbU3/exec';
    let globalHistoryData = [];
    let currentData = null; // Simpan data aktif

    async function cariData() {
        const kw = document.getElementById('searchInput').value.trim();
        if(!kw) return;
        showLoader(true);
        resetUI();
        try {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'getDetailAll', keyword: kw }) });
            const r = await res.json();
            showLoader(false);
            if(r.success) {
                if(r.type === 'LIST') {
                    globalHistoryData = r.data;
                    renderHistory();
                    if(r.data.length > 0) quickView(r.data[0].id);
                } else if(r.type === 'WO') { showWO(r.data); }
                else if(r.type === 'Nota') { currentData = r.data; showNota(r.data); }
            } else { document.getElementById('noData').style.display = 'block'; }
        } catch(e) { showLoader(false); }
    }

    function renderHistory() {
        document.getElementById('cardHistory').style.display = 'block';
        document.getElementById('historyList').innerHTML = globalHistoryData.map(i => `
            <div class="history-item" id="item-${i.id}" onclick="quickView('${i.id}')">
                <div class="d-flex align-items-center">
                    <div class="bg-light p-2 rounded-3 me-3"><i class="fas ${i.type=='WO'?'fa-tools text-primary':'fa-file-invoice-dollar text-success'}"></i></div>
                    <div><div class="fw-bold small">${i.id}</div><div class="text-muted" style="font-size:10px">${i.judul}</div></div>
                </div>
                <i class="fas fa-chevron-right text-muted fa-xs"></i>
            </div>`).join('');
    }

    async function quickView(id) {
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active-item'));
        if(document.getElementById('item-'+id)) document.getElementById('item-'+id).classList.add('active-item');
        showLoader(true);
        try {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'getDetailAll', keyword: id }) });
            const r = await res.json();
            showLoader(false);
            if(r.success) {
                currentData = r.data;
                document.getElementById('cardWO').style.display = 'none';
                document.getElementById('cardNota').style.display = 'none';
                if(r.type === 'WO') showWO(r.data);
                else if(r.type === 'Nota') showNota(r.data);
            }
        } catch(e) { showLoader(false); }
    }

    function showWO(d) {
        document.getElementById('cardWO').style.display = 'block';
        document.getElementById('woIdDisplay').innerText = d.woId;
        document.getElementById('woCustomer').innerText = d.email;
        document.getElementById('woStatus').innerText = d.status;
        document.getElementById('woHistory').innerHTML = d.history.map(h => `
            <div class="status-step">
                <div class="small fw-bold text-dark">${h.status}</div>
                <div class="text-muted" style="font-size:9px">${h.tgl}</div>
                <div class="small text-secondary mt-1">${h.detail || '-'}</div>
            </div>`).join('');
    }

    function showNota(d) {
        document.getElementById('cardNota').style.display = 'block';
        document.getElementById('notaIdDisplay').innerText = "#" + d.notaId;
        document.getElementById('notaTotal').innerText = "Rp " + d.total.toLocaleString('id-ID');
        document.getElementById('notaItems').innerHTML = d.items.map(it => `
            <tr><td>${it.nama}<br><small class="text-muted">${it.qty} x ${it.harga.toLocaleString('id-ID')}</small></td>
            <td class="text-end fw-bold">Rp ${(it.qty * it.harga).toLocaleString('id-ID')}</td></tr>`).join('');
    }

    // INTEGRASI FUNGSI PDF SMEAN
    function downloadNotaPDF() {
        if(!currentData) return;
        const data = currentData;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // --- 1. HEADER KOP SURAT ---
        try { doc.addImage('logo-none-text.png', 'PNG', 15, 12, 23, 23); } catch (e) {}
        doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.setTextColor(40, 40, 40);
        doc.text("NANDA TEKNIK BANYUWANGI", 45, 20);
        doc.setFontSize(9); doc.setFont("helvetica", "normal"); doc.setTextColor(100); 
        doc.text("Software, Network & Electrical Engineering", 45, 26);
        doc.setFontSize(8); doc.text("Sukowidi Indah Residence D-5, Klatak, Banyuwangi - Jawa Timur", 45, 31);
        doc.text("WA: 082331201148 | Email: nandateknik02@gmail.com", 45, 35);
        doc.setDrawColor(80, 80, 80); doc.line(15, 40, 195, 40);

        // --- 2. INFO SURAT ---
        doc.setTextColor(0); doc.setFontSize(12); doc.setFont("helvetica", "bold");
        doc.text("NOTA LAYANAN / INVOICE", 105, 50, { align: "center" });
        doc.setFontSize(9); doc.setFont("helvetica", "normal");
        doc.text(`No. Nota    : #${data.notaId}`, 15, 60);
        doc.text(`Tanggal     : ${data.tanggal}`, 15, 65);
        doc.text("Kepada Yth:", 130, 60);
        doc.setFont("helvetica", "bold"); doc.text(data.email, 130, 65);

        // --- 3. TABLE ITEMS ---
        const tableBody = data.items.map((item, index) => [
            index + 1, item.nama, item.qty, 
            `Rp ${item.harga.toLocaleString('id-ID')}`, 
            `Rp ${(item.harga * item.qty).toLocaleString('id-ID')}`
        ]);

        doc.autoTable({
            startY: 75,
            head: [['NO', 'DESKRIPSI PEKERJAAN', 'QTY', 'HARGA', 'JUMLAH']],
            body: tableBody,
            theme: 'grid',
            headStyles: { fillColor: [80, 80, 80], halign: 'center' },
            columnStyles: { 0: {halign:'center'}, 2: {halign:'center'}, 3: {halign:'right'}, 4: {halign:'right'} }
        });

        // --- 4. TOTAL & TTD ---
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL PEMBAYARAN: Rp ${data.total.toLocaleString('id-ID')}`, 192, finalY, { align: "right" });
        
        const ttdY = finalY + 25;
        doc.setFont("helvetica", "normal");
        doc.text(`Banyuwangi, ${data.tanggal}`, 145, ttdY);
        doc.text("Hormat Kami,", 145, ttdY + 5);
        doc.setFont("helvetica", "bold");
        doc.text("NANDA KRISBIANTO", 145, ttdY + 25);

        doc.save(`Nota_NandaTeknik_${data.notaId}.pdf`);
    }

    function resetUI() { ['cardWO', 'cardNota', 'cardHistory', 'noData'].forEach(id => document.getElementById(id).style.display = 'none'); }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
