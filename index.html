<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal | Nanda Teknik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --p-blue: #0052D4; --p-dark: #1e293b; --bg-soft: #f8fafc; }
        body { background: var(--bg-soft); font-family: 'Inter', sans-serif; color: var(--p-dark); }
        
        /* Header Style */
        .portal-header { background: linear-gradient(135deg, #0052D4 0%, #4364F7 100%); padding: 60px 0 100px; color: white; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .search-container { max-width: 600px; margin: -50px auto 0; padding: 0 20px; }
        .search-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: none; }
        
        /* Tab Style */
        .nav-pills .nav-link { color: #64748b; font-weight: 600; border-radius: 12px; padding: 12px 20px; }
        .nav-pills .nav-link.active { background: var(--p-blue); color: white; }

        /* Ticket Style */
        .ticket-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: none; border-left: 5px solid #ddd; transition: 0.3s; cursor: pointer; }
        .ticket-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .status-active { border-left-color: #3b82f6; }
        .status-done { border-left-color: #10b981; }
        .status-pending { border-left-color: #f59e0b; }

        .progress-log { border-left: 2px dashed #e2e8f0; margin-left: 10px; padding-left: 20px; position: relative; }
        .progress-item::before { content: ''; position: absolute; left: -7px; top: 5px; width: 12px; height: 12px; background: var(--p-blue); border-radius: 50%; }

        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="loader-overlay" id="loader">
    <div class="spinner-border text-primary mb-2"></div>
    <span class="fw-bold">Nggoleki Data...</span>
</div>

<div class="portal-header text-center">
    <h2 class="fw-bold">Customer Portal</h2>
    <p class="opacity-75">Tracking pekerjaan & cek nota dadi siji</p>
</div>

<div class="search-container">
    <div class="search-card animate__animated animate__fadeIn">
        <label class="form-label small fw-bold text-muted text-uppercase">Input Email Anda</label>
        <div class="input-group">
            <span class="input-group-text bg-light border-0"><i class="fas fa-envelope text-primary"></i></span>
            <input type="email" id="emailInput" class="form-control form-control-lg bg-light border-0" placeholder="contoh@mail.com" onkeypress="if(event.key==='Enter') loadData()">
            <button class="btn btn-primary px-4 fw-bold shadow-sm" onclick="loadData()">CARI</button>
        </div>
        <div id="welcomeMsg" class="mt-3 small text-center text-muted" style="display:none;"></div>
    </div>
</div>

<div class="container mt-5 pb-5">
    <div id="mainContent" style="display:none;">
        <ul class="nav nav-pills mb-4 justify-content-center gap-2" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabActive"><i class="fas fa-tools me-2"></i>Status Pekerjaan</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabHistory"><i class="fas fa-file-invoice-dollar me-2"></i>Riwayat Nota</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="tabActive">
                <div id="listPekerjaan"></div>
            </div>

            <div class="tab-pane fade" id="tabHistory">
                <div id="listNota"></div>
            </div>
        </div>
    </div>

    <div id="emptyState" class="text-center py-5 opacity-50">
        <i class="fas fa-search fa-3x mb-3"></i>
        <p>Lebokne emailmu nggo ndelok history servis.</p>
    </div>
</div>

<div class="modal fade" id="modalDetail" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold" id="detailTitle">Detail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailBody"></div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-dark rounded-pill px-4 d-none" id="btnPdfAction">Download PDF</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/config.js"></script>

<script>
    let userData = { jobs: [], notes: [] };
    const myModal = new bootstrap.Modal(document.getElementById('modalDetail'));

    async function loadData() {
        const email = document.getElementById('emailInput').value.trim();
        if(!email) return alert("Email kudu diisi!");

        document.getElementById('loader').style.display = 'flex';
        
        try {
            const res = await fetch(CONFIG.WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getCustomerHistory', email: email })
            });
            const result = await res.json();
            
            document.getElementById('loader').style.display = 'none';
            
            if(result.success) {
                userData.jobs = result.jobs;
                userData.notes = result.notes;
                
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('welcomeMsg').style.display = 'block';
                document.getElementById('welcomeMsg').innerHTML = `Sugeng rawuh, <b>${result.customer.nama}</b>`;
                
                renderJobs();
                renderNotes();
            } else {
                alert("Data email ora ketemu!");
            }
        } catch (e) {
            document.getElementById('loader').style.display = 'none';
            alert("Gagal nyambung neng server!");
        }
    }

    function renderJobs() {
        const container = document.getElementById('listPekerjaan');
        if(userData.jobs.length === 0) {
            container.innerHTML = `<div class="text-center p-5 text-muted">Ora ono pekerjaan aktif.</div>`;
            return;
        }

        container.innerHTML = userData.jobs.map(j => `
            <div class="ticket-card status-active shadow-sm" onclick="showJobDetail('${j.id}')">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="badge bg-light text-primary mb-2">${j.id}</span>
                        <h6 class="fw-bold mb-1">${j.judul}</h6>
                        <small class="text-muted"><i class="far fa-calendar-alt me-1"></i> ${j.tanggal}</small>
                    </div>
                    <span class="badge ${j.status === 'Selesai' ? 'bg-success' : 'bg-primary'} rounded-pill">${j.status}</span>
                </div>
            </div>
        `).join('');
    }

    function renderNotes() {
        const container = document.getElementById('listNota');
        if(userData.notes.length === 0) {
            container.innerHTML = `<div class="text-center p-5 text-muted">Ora ono riwayat nota.</div>`;
            return;
        }

        container.innerHTML = userData.notes.map(n => `
            <div class="ticket-card status-done shadow-sm" onclick="showNoteDetail('${n.id}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-bold mb-0">Nota #${n.id}</h6>
                        <small class="text-muted">${n.tanggal}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-primary">Rp ${Number(n.total).toLocaleString()}</div>
                        <small class="badge bg-light text-dark border">${n.status}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function showJobDetail(id) {
        const job = userData.jobs.find(j => j.id === id);
        document.getElementById('detailTitle').innerText = "Progress Pekerjaan";
        document.getElementById('btnPdfAction').classList.add('d-none');
        
        let logs = [];
        try { logs = JSON.parse(job.progress_json || '[]'); } catch(e) {}

        let logHtml = logs.map(l => `
            <div class="progress-item mb-4 position-relative">
                <div class="small text-muted fw-bold">${l.tgl}</div>
                <div class="fw-bold">${l.status}</div>
                <div class="small text-muted">${l.detail || ''}</div>
            </div>
        `).join('') || '<p class="text-muted">Pekerjaan nembe diproses.</p>';

        document.getElementById('detailBody').innerHTML = `
            <div class="mb-3">
                <small class="text-muted">Judul Pekerjaan:</small>
                <div class="fw-bold">${job.judul}</div>
            </div>
            <hr>
            <div class="progress-log">
                ${logHtml}
            </div>
        `;
        myModal.show();
    }

    function showNoteDetail(id) {
        const note = userData.notes.find(n => n.id === id);
        document.getElementById('detailTitle').innerText = "Rincian Nota";
        
        let items = [];
        try { items = JSON.parse(note.items_json || '[]'); } catch(e) {}

        let tableHtml = `
            <table class="table table-sm small mt-3">
                <thead><tr><th>Item</th><th>Qty</th><th class="text-end">Subtotal</th></tr></thead>
                <tbody>
                    ${items.map(it => `<tr><td>${it.nama}</td><td>${it.qty}</td><td class="text-end">${(it.harga * it.qty).toLocaleString()}</td></tr>`).join('')}
                </tbody>
                <tfoot><tr><th colspan="2">TOTAL</th><th class="text-end text-primary">Rp ${Number(note.total).toLocaleString()}</th></tr></tfoot>
            </table>
        `;

        document.getElementById('detailBody').innerHTML = `
            <div class="text-center mb-3">
                <h6 class="text-muted mb-1">Nota ID: ${note.id}</h6>
                <div class="small">${note.tanggal}</div>
            </div>
            ${tableHtml}
        `;
        
        const btnPdf = document.getElementById('btnPdfAction');
        btnPdf.classList.remove('d-none');
        btnPdf.onclick = () => generatePDF(note);
        
        myModal.show();
    }

    // Logic PDF tetep nganggo soko pratinjau sadurunge
    function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        // ... (Tambahkan logic generatePDF-mu neng kene) ...
        alert("Downloading PDF Nota: " + data.id);
        doc.save(`Nota_${data.id}.pdf`);
    }
</script>
</body>
</html>
