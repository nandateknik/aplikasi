<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanda Teknik - Portal Layanan</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        :root { --p-blue: #0d6efd; --p-dark: #1e293b; --bg-light: #f8fafc; }
        body { background: var(--bg-light); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 100px; }
        
        /* Hero Search Section */
        .hero-search {
            padding: 60px 20px 40px;
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }
        .google-box { max-width: 600px; margin: 0 auto; position: relative; }
        .google-box input {
            width: 100%; padding: 18px 25px 18px 55px; border-radius: 50px;
            border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            font-size: 1.1rem; transition: 0.3s;
        }
        .google-box input:focus { outline: none; border-color: var(--p-blue); box-shadow: 0 8px 25px rgba(13, 110, 253, 0.15); }
        .search-icon { position: absolute; left: 22px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* Queue Box (Antrean) */
        .queue-container { background: white; border-radius: 20px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 30px; }
        .queue-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .queue-item:last-child { border-bottom: none; }
        .dot-pulse { width: 10px; height: 10px; background: #fbbf24; border-radius: 50%; margin-right: 15px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Result Cards */
        .result-card {
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px;
            border-left: 6px solid var(--p-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: 0.3s; cursor: pointer;
        }
        .result-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

        /* Blog Section */
        .blog-card {
            background: white; border-radius: 18px; padding: 12px; height: 100%;
            border: 1px solid rgba(0,0,0,0.05); transition: 0.3s; text-decoration: none; display: block;
        }
        .blog-card:hover { transform: translateY(-5px); border-color: var(--p-blue); }
        .blog-title {
            font-size: 0.95rem; font-weight: 700; color: var(--p-dark);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; margin: 10px 0; line-height: 1.4;
        }

        /* Pagination */
        .page-btn { border: 1px solid #e2e8f0; background: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .page-btn:disabled { opacity: 0.5; }

        /* Floating Button */
        .fab-button { position: fixed; bottom: 30px; right: 20px; z-index: 1050; }
        .btn-order {
            background: var(--p-blue); color: white; padding: 15px 25px; border-radius: 50px;
            font-weight: 700; box-shadow: 0 10px 25px rgba(13, 110, 253, 0.4);
            text-decoration: none; display: flex; align-items: center; gap: 10px;
        }

        .section-label { font-size: 0.9rem; font-weight: 800; color: var(--p-dark); text-transform: uppercase; letter-spacing: 1px; }
        .status-badge { font-size: 0.7rem; padding: 4px 12px; border-radius: 10px; font-weight: 700; }
    </style>
</head>
<body>

<div class="hero-search">
    <div class="container">
        <div class="animate__animated animate__fadeIn">
            <h2 class="fw-bold text-dark mb-1">Nanda Teknik</h2>
            <p class="text-muted small mb-4">Tracking Layanan & Update Berita Terkini</p>
        </div>
        <div class="google-box animate__animated animate__zoomIn">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="mainSearch" placeholder="Cek No. Invoice, Nama, atau Email..." oninput="handleSearch(this.value)">
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-9">
            
            <div id="searchResultsArea" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="section-label">Hasil Pencarian</span>
                    <button class="btn btn-sm btn-link text-decoration-none" onclick="resetSearch()">Tutup</button>
                </div>
                <div id="resultsList"></div>
                <div id="paginationBox" class="d-flex justify-content-center gap-2 mt-3 mb-5"></div>
            </div>

            <div id="queueView">
                <div class="section-label mb-3"><i class="fas fa-clock text-warning me-2"></i>Antrean Teknisi (On-Progress)</div>
                <div class="queue-container shadow-sm" id="queueList">
                    <p class="text-muted small p-2">Memuat data antrean...</p>
                </div>
            </div>

            <div class="mt-5" id="blogView">
                <div class="d-flex align-items-center mb-4">
                    <span class="section-label">Artikel & Tips Terbaru</span>
                    <hr class="flex-grow-1 ms-3 opacity-25">
                </div>
                <div id="blog-container" class="row g-3"></div>
                <div class="text-center mt-4">
                    <a href="https://www.nandateknik.com" target="_blank" class="btn btn-sm btn-outline-secondary rounded-pill px-4">Lihat Semua Artikel</a>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="fab-button animate__animated animate__bounceInUp">
    <a href="buat-booking.html" class="btn-order">
        <i class="fas fa-plus-circle fa-lg"></i>
        <span>BUAT PEKERJAAN BARU</span>
    </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="config.js"></script>

<script>
    let dbBooking = [], dbNota = [], dbPelanggan = [];
    let currentPage = 1;
    const itemsPerPage = 3;

    window.onload = async () => {
        await fetchAllData();
        await fetchBlog();
        renderQueue();
    };

    async function fetchAllData() {
        try {
            const [resB, resN, resP] = await Promise.all([
                fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Booking`),
                fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Penawaran`),
                fetch(`${CONFIG.WEB_APP_URL}?action=read&sheet=Pelanggan`)
            ]);
            dbBooking = (await resB.json()).data || [];
            dbNota = (await resN.json()).data || [];
            dbPelanggan = (await resP.json()).data || [];
        } catch (e) { console.error("Database error"); }
    }

    function renderQueue() {
        const jobs = dbBooking.filter(j => j.status !== "Selesai" && j.status !== "Dibatalkan");
        const container = document.getElementById('queueList');
        if (jobs.length === 0) {
            container.innerHTML = '<p class="text-muted small p-2">Tidak ada antrean saat ini.</p>';
            return;
        }
        container.innerHTML = jobs.map(j => `
            <div class="queue-item">
                <div class="dot-pulse"></div>
                <div class="flex-grow-1">
                    <div class="fw-bold small text-dark">${j.judul}</div>
                    <div class="text-muted" style="font-size: 11px;">#${j.id} | ${j.nama || 'User'} | <span class="text-primary">${j.status}</span></div>
                </div>
                <div class="text-end text-muted" style="font-size: 10px;">${j.tanggal || j.tgl || ''}</div>
            </div>
        `).join('');
    }

    async function fetchBlog() {
        const container = document.getElementById('blog-container');
        const FEED_URL = encodeURIComponent(`https://www.nandateknik.com/feeds/posts/default?alt=rss`);
        try {
            const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${FEED_URL}`);
            const data = await res.json();
            if (data.status === 'ok') {
                container.innerHTML = data.items.slice(0, 3).map(post => {
                    const temp = document.createElement('div');
                    temp.innerHTML = post.description;
                    const img = temp.querySelector('img');
                    const thumb = img ? img.src : 'https://via.placeholder.com/400x250';
                    return `
                        <div class="col-md-4">
                            <a href="${post.link}" target="_blank" class="blog-card animate__animated animate__fadeIn">
                                <img src="${thumb}" class="w-100 rounded-3" style="height:140px; object-fit:cover;">
                                <div class="blog-date mt-2" style="font-size:0.7rem; color:#94a3b8;">${new Date(post.pubDate).toLocaleDateString('id-ID')}</div>
                                <div class="blog-title">${post.title}</div>
                                <div class="text-primary small fw-bold">Selengkapnya <i class="fas fa-arrow-right ms-1"></i></div>
                            </a>
                        </div>`;
                }).join('');
            }
        } catch (e) { container.innerHTML = '<p class="text-center small text-muted">Gagal memuat feed.</p>'; }
    }

    function handleSearch(query) {
        if (query.length < 3) {
            document.getElementById('searchResultsArea').style.display = 'none';
            document.getElementById('queueView').style.display = 'block';
            document.getElementById('blogView').style.display = 'block';
            return;
        }

        document.getElementById('searchResultsArea').style.display = 'block';
        document.getElementById('queueView').style.display = 'none';
        document.getElementById('blogView').style.display = 'none';

        const filtered = dbNota.filter(item => 
            item.id.toString().toLowerCase().includes(query.toLowerCase()) ||
            item.email.toLowerCase().includes(query.toLowerCase()) ||
            (item.perihal && item.perihal.toLowerCase().includes(query.toLowerCase()))
        );

        renderResults(filtered);
    }

    function renderResults(data) {
        const container = document.getElementById('resultsList');
        const start = (currentPage - 1) * itemsPerPage;
        const pagedData = data.slice(start, start + itemsPerPage);

        if (data.length === 0) {
            container.innerHTML = '<div class="text-center py-5">Data tidak ditemukan.</div>';
            document.getElementById('paginationBox').innerHTML = '';
            return;
        }

        container.innerHTML = pagedData.map(row => `
            <div class="result-card animate__animated animate__fadeInUp" onclick="viewDetail('${row.id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <span class="text-primary fw-bold small">#INV-${row.id}</span>
                        <h6 class="fw-bold mt-1 mb-1">${row.perihal || 'Layanan Teknik'}</h6>
                        <div class="text-muted small">${row.email}</div>
                    </div>
                    <span class="status-badge bg-light text-primary border">${row.status}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <span class="fw-bold fs-5 text-dark">Rp ${Number(row.total).toLocaleString('id-ID')}</span>
                    <button class="btn btn-primary btn-sm rounded-pill px-3">Detail</button>
                </div>
            </div>
        `).join('');

        renderPagination(data.length, (newData) => renderResults(data));
    }

    function renderPagination(totalItems, callback) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const box = document.getElementById('paginationBox');
        if (totalPages <= 1) { box.innerHTML = ''; return; }

        box.innerHTML = `
            <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">Prev</button>
            <span class="small align-self-center">Hal ${currentPage} / ${totalPages}</span>
            <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(1)">Next</button>
        `;
    }

    function changePage(step) {
        currentPage += step;
        const query = document.getElementById('mainSearch').value;
        handleSearch(query);
    }

    function resetSearch() {
        document.getElementById('mainSearch').value = '';
        handleSearch('');
    }

    function viewDetail(id) {
        const item = dbNota.find(d => d.id == id);
        if(!item) return;
        Swal.fire({
            title: 'Detail Invoice',
            html: `
                <div id="printArea" class="text-start p-3 bg-white border">
                    <h5 class="fw-bold text-primary">NANDA TEKNIK</h5>
                    <hr>
                    <p class="small">
                        ID: <b>#${item.id}</b><br>
                        Perihal: <b>${item.perihal}</b><br>
                        Total: <b>Rp ${Number(item.total).toLocaleString('id-ID')}</b><br>
                        Status: <b class="text-success">${item.status}</b>
                    </p>
                </div>
                <button class="btn btn-success mt-3 w-100 rounded-pill" onclick="downloadPDF('${item.id}')">Download PDF</button>
            `,
            showConfirmButton: false, showCloseButton: true
        });
    }

    function downloadPDF(id) {
        const element = document.getElementById('printArea');
        html2pdf().from(element).set({ margin: 10, filename: `Invoice-${id}.pdf` }).save();
    }
</script>
</body>
</html>
