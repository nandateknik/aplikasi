<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail & Tracking - Nanda Teknik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .card-custom { border-radius: 15px; border: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; margin-bottom: 20px; }
        .status-step { border-left: 2px solid #dee2e6; padding-left: 20px; position: relative; padding-bottom: 20px; }
        .status-step::before { content: ""; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: #0d6efd; }
        .admin-tools { display: none; background: #fff3cd; padding: 10px; border-radius: 10px; margin-top: 15px; border: 1px dashed #ffc107; }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="loader-overlay" id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <span class="mt-2 fw-bold">Sinkronisasi Data...</span>
</div>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            
            <div class="bg-white p-3 rounded-4 shadow-sm mb-4">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control border-0 bg-light" placeholder="Email / ID WO / ID Nota...">
                    <button class="btn btn-primary px-4" onclick="cariData()">Cari</button>
                </div>
            </div>

            <div id="cardWO" class="card card-custom p-4 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-primary mb-0"><i class="fas fa-tools"></i> WORK ORDER DETAIL</h5>
                    <span id="woStatus" class="badge bg-warning text-dark">Pending</span>
                </div>
                <div class="mb-3">
                    <h4 id="woIdDisplay" class="fw-bold mb-0">WO-XXXX</h4>
                    <small id="woCustomer" class="text-muted">customer@email.com</small>
                </div>
                <hr>
                <div class="mb-4">
                    <h6><strong>Progress History:</strong></h6>
                    <div id="woHistory" class="mt-3">
                        </div>
                </div>

                <div class="admin-tools" id="adminToolsWO">
                    <p class="small fw-bold mb-2 text-danger"><i class="fas fa-user-shield"></i> ADMIN PANEL</p>
                    <button class="btn btn-sm btn-dark" onclick="updateStatus()"><i class="fas fa-edit"></i> Update Progress</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="hapusData('WO')"><i class="fas fa-trash"></i> Hapus WO</button>
                </div>
            </div>

            <div id="cardNota" class="card card-custom p-4 bg-white border-top border-5 border-success">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-success mb-0"><i class="fas fa-file-invoice-dollar"></i> NOTA TRANSAKSI</h5>
                    <button class="btn btn-sm btn-outline-success" onclick="downloadPDF()"><i class="fas fa-download"></i> PDF</button>
                </div>
                <div class="mb-3">
                    <h4 id="notaIdDisplay" class="fw-bold mb-0">NOTA-XXXX</h4>
                    <small id="notaDate" class="text-muted">--/--/--</small>
                </div>
                
                <div id="notaItems" class="bg-light p-3 rounded-3 mb-3">
                    </div>

                <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total:</span>
                    <span id="notaTotal" class="text-success">Rp 0</span>
                </div>

                <div class="admin-tools" id="adminToolsNota">
                    <p class="small fw-bold mb-2 text-danger"><i class="fas fa-user-shield"></i> ADMIN PANEL</p>
                    <button class="btn btn-sm btn-dark" onclick="editNota()"><i class="fas fa-pen"></i> Edit Item</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="hapusData('Nota')"><i class="fas fa-trash"></i> Batalkan Nota</button>
                </div>
            </div>

            <div id="noData" class="text-center py-5" style="display:none;">
                <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="100" class="mb-3 opacity-50">
                <h5>Data Tidak Ditemukan</h5>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwW7nu1lYIxDBReKbTq-Dk7gFTZMl-3uO4MHux1v-3wOpKTGjlb02tlsV4EtGOIg8IT/exec';
    
    window.onload = () => {
        // Cek Role Admin
        const role = localStorage.getItem('role');
        if(role === 'admin') {
            document.querySelectorAll('.admin-tools').forEach(el => el.style.display = 'block');
        }

        // Cek URL Params
        const id = new URLSearchParams(window.location.search).get('id');
        if(id) {
            document.getElementById('searchInput').value = id;
            cariData(id);
        }
    };

    async function cariData() {
        const keyword = document.getElementById('searchInput').value;
        if(!keyword) return;

        document.getElementById('loader').style.display = 'flex';
        resetTampilan();

        try {
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getDetailAll', keyword: keyword })
            });
            const result = await res.json();
            document.getElementById('loader').style.display = 'none';

            if(result.success) {
                if(result.type === 'WO') {
                    showWO(result.data);
                } else if(result.type === 'Nota') {
                    showNota(result.data);
                }
            } else {
                document.getElementById('noData').style.display = 'block';
            }
        } catch(e) {
            document.getElementById('loader').style.display = 'none';
            console.error(e);
        }
    }

    function showWO(data) {
        document.getElementById('cardWO').style.display = 'block';
        document.getElementById('woIdDisplay').innerText = data.woId;
        document.getElementById('woCustomer').innerText = data.email;
        document.getElementById('woStatus').innerText = data.status;
        
        let historyHTML = '';
        data.history.forEach(h => {
            historyHTML += `
                <div class="status-step">
                    <div class="small fw-bold">${h.tgl}</div>
                    <div class="small text-muted">${h.ket}</div>
                </div>
            `;
        });
        document.getElementById('woHistory').innerHTML = historyHTML;
    }

    function showNota(data) {
        document.getElementById('cardNota').style.display = 'block';
        document.getElementById('notaIdDisplay').innerText = "#" + data.notaId;
        document.getElementById('notaDate').innerText = data.tanggal;
        document.getElementById('notaTotal').innerText = "Rp " + data.total.toLocaleString();
        
        let itemHTML = '';
        data.items.forEach(it => {
            itemHTML += `<div class="d-flex justify-content-between small border-bottom mb-1 pb-1">
                <span>${it.nama} (x${it.qty})</span>
                <span>Rp ${(it.harga * it.qty).toLocaleString()}</span>
            </div>`;
        });
        document.getElementById('notaItems').innerHTML = itemHTML;
    }

    function resetTampilan() {
        document.getElementById('cardWO').style.display = 'none';
        document.getElementById('cardNota').style.display = 'none';
        document.getElementById('noData').style.display = 'none';
    }

    // --- FITUR ADMIN ---
    async function hapusData(type) {
        const id = document.getElementById(type === 'WO' ? 'woIdDisplay' : 'notaIdDisplay').innerText;
        
        const confirm = await Swal.fire({
            title: 'Hapus Data?',
            text: `Apakah anda yakin ingin menghapus ${id}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33'
        });

        if(confirm.isConfirmed) {
            // Tembak API Action: 'deleteData', id: id
            Swal.fire('Terhapus!', 'Data berhasil dihapus dari sistem.', 'success').then(() => location.reload());
        }
    }

    function updateStatus() {
        Swal.fire({
            title: 'Update Progress',
            input: 'select',
            inputOptions: {
                'Proses': 'Proses',
                'Selesai': 'Selesai',
                'Dibatalkan': 'Dibatalkan'
            },
            showCancelButton: true
        }).then((res) => {
            if(res.value) {
                // Tembak API Update Status
                Swal.fire('Updated!', 'Status berhasil diperbarui.', 'success');
            }
        });
    }

    function downloadPDF() {
        Swal.fire('Info', 'Fitur PDF Generator sedang disiapkan (menggunakan jsPDF)', 'info');
    }
</script>
</body>
</html>
