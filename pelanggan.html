<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pelanggan Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8f9fa; font-size: 14px; }
        #map { height: 200px; border-radius: 8px; margin-bottom: 10px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-mobile { border-radius: 50px; }
    </style>
</head>
<body>

<div class="container mt-4 mb-5">
    <h4 class="text-center fw-bold mb-4">CRM Pelanggan</h4>

    <div class="card p-3 mb-4">
        <h6 id="formTitle" class="fw-bold">Tambah Pelanggan Baru</h6>
        <div id="map"></div>
        <form id="crmForm">
            <input type="hidden" id="rowId">
            <div class="mb-2">
                <input type="text" id="nama" class="form-control" placeholder="Nama Lengkap" required>
            </div>
            <div class="mb-2">
                <input type="email" id="email" class="form-control" placeholder="Email" required>
            </div>
            <div class="mb-2">
                <input type="text" id="whatsapp" class="form-control" placeholder="WhatsApp (628...)" required>
            </div>
            <div class="row">
                <div class="col"><input type="text" id="lat" class="form-control mb-2" placeholder="Lat" readonly></div>
                <div class="col"><input type="text" id="lang" class="form-control mb-2" placeholder="Lang" readonly></div>
            </div>
            <div class="mb-3">
                <textarea id="alamat" class="form-control" placeholder="Alamat Otomatis dr Maps" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-mobile" id="btnSubmit">Simpan Pelanggan</button>
            <button type="button" class="btn btn-secondary w-100 btn-mobile mt-2 d-none" id="btnCancel" onclick="resetForm()">Batal</button>
        </form>
    </div>

    <div id="customerList">
        </div>

    <nav class="mt-3">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLFGl3vOHyHU7aD-53fxx6O5qoqDtshRauBKBL2cKE1Q4E-In60pE9xy6czgIPTMBX/exec";
    let map, marker;
    let currentPage = 1;

    // Initialize Map
    function initMap() {
        map = L.map('map').setView([-6.2000, 106.8166], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                updateLocation(latitude, longitude);
            });
        }

        map.on('click', e => updateLocation(e.latlng.lat, e.latlng.lng));
    }

    async function updateLocation(lat, lng) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 15);
        document.getElementById('lat').value = lat;
        document.getElementById('lang').value = lng;

        // Reverse Geocoding simple
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await res.json();
            document.getElementById('alamat').value = data.display_name;
        } catch (e) { console.error(e) }
    }

    // Load Data
    async function loadData(page = 1) {
        currentPage = page;
        const resp = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'read', page: page })
        });
        const result = await resp.json();
        
        let html = '';
        result.data.forEach(c => {
            html += `
            <div class="card p-3 mb-2">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="fw-bold">${c.nama}</div>
                        <small class="text-muted">${c.whatsapp} | ${c.is_active}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-warning" onclick='editData(${JSON.stringify(c)})'>Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteData(${c.row})">Hapus</button>
                    </div>
                </div>
            </div>`;
        });
        document.getElementById('customerList').innerHTML = html;
        renderPagination(result.total, result.limit);
    }

    // CRUD Logic
    document.getElementById('crmForm').onsubmit = async (e) => {
        e.preventDefault();
        const action = document.getElementById('rowId').value ? 'update' : 'create';
        const data = {
            action: action,
            row: document.getElementById('rowId').value,
            nama: document.getElementById('nama').value,
            email: document.getElementById('email').value,
            whatsapp: document.getElementById('whatsapp').value,
            lat: document.getElementById('lat').value,
            lang: document.getElementById('lang').value,
            alamat: document.getElementById('alamat').value,
            is_active: "Active"
        };

        Swal.fire({ title: 'Memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        Swal.fire('Berhasil!', 'Data telah disimpan.', 'success');
        resetForm();
        loadData(currentPage);
    };

    function editData(c) {
        document.getElementById('rowId').value = c.row;
        document.getElementById('nama').value = c.nama;
        document.getElementById('email').value = c.email;
        document.getElementById('whatsapp').value = c.whatsapp;
        document.getElementById('alamat').value = c.alamat;
        document.getElementById('formTitle').innerText = "Update Pelanggan";
        document.getElementById('btnCancel').classList.remove('d-none');
        updateLocation(c.lat, c.lang);
    }

    async function deleteData(row) {
        const confirm = await Swal.fire({
            title: 'Hapus data?',
            text: "Data tidak bisa dikembalikan!",
            icon: 'warning',
            showCancelButton: true
        });

        if (confirm.isConfirmed) {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', row: row }) });
            loadData(currentPage);
        }
    }

    function resetForm() {
        document.getElementById('crmForm').reset();
        document.getElementById('rowId').value = '';
        document.getElementById('formTitle').innerText = "Tambah Pelanggan Baru";
        document.getElementById('btnCancel').classList.add('d-none');
    }

    function renderPagination(total, limit) {
        const pages = Math.ceil(total / limit);
        let pgHtml = '';
        for (let i = 1; i <= pages; i++) {
            pgHtml += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="javascript:void(0)" onclick="loadData(${i})">${i}</a></li>`;
        }
        document.getElementById('pagination').innerHTML = pgHtml;
    }

    window.onload = () => { initMap(); loadData(); };
</script>
</body>
</html>
