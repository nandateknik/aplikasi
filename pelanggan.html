<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pelanggan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        body { background: #f8f9fa; font-family: sans-serif; }
        #map { height: 300px; border-radius: 10px; margin-bottom: 15px; }
        .spinner-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div class="spinner-overlay" id="loader">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<div class="container py-4">
    <h4 class="mb-4 text-center">Registrasi Pelanggan</h4>
    
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div id="step1">
                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" id="email" class="form-control" placeholder="user@mail.com">
                </div>
                <button onclick="prosesEmail()" class="btn btn-primary w-100">Lanjut</button>
            </div>

            <div id="stepForm" class="d-none">
                <div class="mb-3"><input type="text" id="nama" class="form-control" placeholder="Nama Lengkap"></div>
                <div class="mb-3"><input type="text" id="whatsapp" class="form-control" placeholder="No WhatsApp"></div>
                <div id="map"></div>
                <div class="mb-3">
                    <input type="text" id="alamat" class="form-control" placeholder="Alamat Otomatis..." readonly>
                    <input type="hidden" id="lat"> <input type="hidden" id="lang">
                </div>
                <div id="otpSection" class="d-none">
                    <hr>
                    <input type="text" id="otpInput" class="form-control mb-2" placeholder="Masukkan OTP">
                    <button id="btnResend" onclick="sendOTP()" class="btn btn-sm btn-link" disabled>Kirim Ulang (30s)</button>
                </div>
                <button onclick="simpanData()" class="btn btn-success w-100 mt-3">Konfirmasi & Simpan</button>
            </div>
        </div>
    </div>

    <h5 class="mb-3">Daftar Pelanggan</h5>
    <div id="listPelanggan" class="list-group mb-3"></div>
    <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1K6EyZEMBqALn_V85YWOr_XU6oy8vqNplNG9nuisrqXw0d79RhyEhwsguIO8Z6D4J/exec";
    let map, marker, currentOTP;
    let countdown = 30;

    // Inisialisasi Map
    function initMap() {
        map = L.map('map').setView([-6.2000, 106.8166], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Fitur Cari Alamat
        L.Control.geocoder().addTo(map);

        marker = L.marker([-6.2000, 106.8166], {draggable: true}).addTo(map);
        
        marker.on('dragend', function(e) {
            updatePosisi(e.target.getLatLng());
        });

        getLocation();
    }

    function getLocation() {
        document.getElementById('loader').style.display = 'flex';
        navigator.geolocation.getCurrentPosition(pos => {
            const p = {lat: pos.coords.latitude, lng: pos.coords.longitude};
            map.setView(p, 15);
            marker.setLatLng(p);
            updatePosisi(p);
            document.getElementById('loader').style.display = 'none';
        });
    }

    async function updatePosisi(latlng) {
        document.getElementById('lat').value = latlng.lat;
        document.getElementById('lang').value = latlng.lng;
        // Reverse Geocoding sederhana
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`);
        const data = await res.json();
        document.getElementById('alamat').value = data.display_name;
    }

    async function prosesEmail() {
        const email = document.getElementById('email').value;
        if(!email) return Swal.fire('Error', 'Isi email dulu', 'error');

        // Cek Email ke GAS
        const res = await fetch(`${SCRIPT_URL}?action=checkEmail&email=${email}`); // Perbaikan: Sesuaikan metode GET/POST di GAS
        // Logika: Jika exists, arahkan ke pekerjaan.html, jika tidak tampilkan form registrasi + kirim OTP
        document.getElementById('step1').classList.add('d-none');
        document.getElementById('stepForm').classList.remove('d-none');
        initMap();
        sendOTP();
    }

    function sendOTP() {
        // Logika hitung mundur 30 detik
        startTimer();
        Swal.fire('OTP Terkirim', 'Silahkan cek email Anda', 'success');
        // Panggil fetch ke GAS untuk kirim email
    }

    function startTimer() {
        let btn = document.getElementById('btnResend');
        btn.disabled = true;
        let timer = setInterval(() => {
            countdown--;
            btn.innerText = `Kirim Ulang (${countdown}s)`;
            if(countdown <= 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.innerText = "Kirim Ulang";
                countdown = 30;
            }
        }, 1000);
    }

    // Fungsi CRUD lainnya (Simpan, Read, Delete) menyusul dengan fetch ke SCRIPT_URL
</script>
</body>
</html>
